- name: deploy MMA agent
  collections:
    - ansible.windows
  hosts: all
  tasks:


- name: Apply SCCM
  collections:
    - community.vmware
  hosts: all
  tasks:

    - name:  Copy MMA artifacts
      ansible.windows.win_powershell:
         script: |
          net use Z: {{ fileserver_path }} /user:{{ domain_admin_user }} {{ domain_admin_password }}
          robocopy Z:\. C:\temp\ /e
          net use Z: /delete

    - name: Install 7zip from a network share with specific credentials
      ansible.windows.win_package:
        path: C:\temp\MMASetup-AMD64-10.20.18076.0.exe
        arguments: /S
        state: present

    - name: Install MMA silently
      ansible.windows.win_command: > 
        "C:\\temp\\MMASetup-AMD64-10.20.18076.0.exe" /quiet

    - name:  Execute MMA
      ansible.windows.win_powershell:
         script: |
          $workspaceIdSentinel = {{ mma_workspace_key }}
          $workspaceKey = {{ mma_workspace_id }}
          $mma = New-Object -ComObject 'AgentConfigManager.MgmtSvcCfg'
          $mma.AddCloudWorkspace($workspaceIdSentinel, $workspaceKey)
          $mma.ReloadConfiguration()
